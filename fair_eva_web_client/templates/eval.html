{% extends 'base_modern.html' %}
{% block extra_head %}
  {# Tema de color: puedes sobreescribir en static/css/theme.css #}
  <style>
    :root{
      --color-findable: var(--fair-findable, #0072bc);
      --color-accessible: var(--fair-accessible, #2ca02c);
      --color-interoperable: var(--fair-interoperable, #ff7f0e);
      --color-reusable: var(--fair-reusable, #6f42c1);
      --card-radius: 1rem;
    }
    .fair-chip{ font-size:.75rem; padding:.25rem .5rem; border-radius:999px; background:#eef; }
    .score-badge{ font-variant-numeric: tabular-nums; }
    .area-card{ border:0; border-radius: var(--card-radius); box-shadow: 0 6px 18px rgba(0,0,0,.07);}
    .accordion-button:focus{ box-shadow:none; }
    .kpi{ font-weight:700; font-size:1.25rem; }
    .muted{ opacity:.8; }
    .progress{ height:.6rem; }
    .sticky-cta{ position:sticky; bottom:1rem; z-index: 5; }
  </style>

  <style>
    .ring-legend .dot{display:inline-block;width:.7rem;height:.7rem;border-radius:50%;margin-right:.35rem}
    .ring-legend .legend-item{display:inline-flex;align-items:center;gap:.25rem;margin-right:.6rem}
    .ring-card{ border:0; border-radius: var(--card-radius); box-shadow: 0 6px 18px rgba(0,0,0,.07);}
  </style>

  
{% endblock %}

{% block extra_js %}
<!-- Chart.js (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // ===== Serializamos datos desde Jinja -> JS =====
  // Espera objetos con campos: id, title, score, max_score, priority, description...
  const indicatorsByArea = {
    'Findable': {{ (indicators_by_area.get('Findable', []) | tojson) }},
    'Accessible': {{ (indicators_by_area.get('Accessible', []) | tojson) }},
    'Interoperable': {{ (indicators_by_area.get('Interoperable', []) | tojson) }},
    'Reusable': {{ (indicators_by_area.get('Reusable', []) | tojson) }}
  };

  // === Coloreado por % ===
  function colorForPct(p){ 
    if (p >= 80) return '#2ecc71';       // verde
    if (p >= 40) return '#f1c40f';       // ámbar
    return '#e74c3c';                    // rojo
  }

  // Construye datasets tipo doughnut: un dataset = un anillo = un indicador
  function ringDatasetsFor(group){
    const items = (indicatorsByArea[group] || []);
    // Si no hay indicadores, devolvemos un anillo gris para evitar errores
    if (!items.length){
      return [{
        label: 'Sin indicadores',
        data: [0,100],
        backgroundColor: ['#999', 'rgba(0,0,0,0.06)'],
        borderWidth: 0
      }];
    }
    return items.map((it) => {
      const score = Number(it.score || 0);
      const max   = Number(it.max_score || 0) || 1;
      const pct   = Math.max(0, Math.min(100, Math.round((score*100)/max)));
      const col   = colorForPct(pct);
      return {
        label: `${it.id || ''} ${it.title || ''}`.trim(),
        data: [pct, 100 - pct],
        backgroundColor: [col, 'rgba(0,0,0,0.06)'],
        borderWidth: 0,
        rotation: -90,          // empieza arriba
        circumference: 360,     // círculo completo
        weight: 1               // grosor uniforme
      };
    });
  }

  // Render de un canvas ring por grupo
  const _ringCharts = {};
  function renderRings(){
    const groups = ['Findable','Accessible','Interoperable','Reusable'];
    groups.forEach(group => {
      const id = `ring-${group.toLowerCase()}`;
      const canvas = document.getElementById(id);
      if (!canvas) return;
      if (_ringCharts[id]){ _ringCharts[id].destroy(); }

      const ds = ringDatasetsFor(group);

      _ringCharts[id] = new Chart(canvas, {
        type: 'doughnut',
        data: { labels: ds.map(d => d.label), datasets: ds },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '35%', // radio interior
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => items[0]?.dataset?.label || '',
                label: (ctx) => {
                  const ds  = ctx.dataset;
                  const val = Array.isArray(ds.data) ? ds.data[0] : ctx.parsed;
                  const groupKey = (ctx.chart?.canvas?.id?.replace('ring-','') || '');
                  const fullName = groupKey.charAt(0).toUpperCase() + groupKey.slice(1);
                  const items = indicatorsByArea[fullName] || [];
                  const it = items[ctx.datasetIndex] || {};
                  const score = Number(it.score || 0), max = Number(it.max_score || 0) || 1;
                  return [
                    `Score: ${score}/${max}`,
                    `Porcentaje: ${Math.round(val)}%`
                  ];
                }
              }
            }
          }
        }
      });
    });
  }

  // Render inicial cuando el DOM está listo (asegura que existan los canvas)
  document.addEventListener('DOMContentLoaded', renderRings);
</script>

<script>
  // Permitir cambiar tipo de gráfico sin recargar (solo cliente)
  document.querySelectorAll('[data-chart-kind]').forEach(el=>{
    el.addEventListener('click', (ev)=>{
      ev.preventDefault();
      renderFairChart(ev.target.getAttribute('data-chart-kind'));
    });
  });

  const dataAreas = {
    labels: ['Findable','Accessible','Interoperable','Reusable'],
    scores: [
      {{ (summary_by_area.get('Findable', {}).get('score', 0))|int }},
      {{ (summary_by_area.get('Accessible', {}).get('score', 0))|int }},
      {{ (summary_by_area.get('Interoperable', {}).get('score', 0))|int }},
      {{ (summary_by_area.get('Reusable', {}).get('score', 0))|int }}
    ],
    maxs: [
      {{ (summary_by_area.get('Findable', {}).get('max', 0))|int }},
      {{ (summary_by_area.get('Accessible', {}).get('max', 0))|int }},
      {{ (summary_by_area.get('Interoperable', {}).get('max', 0))|int }},
      {{ (summary_by_area.get('Reusable', {}).get('max', 0))|int }}
    ]
  };

  let chart;
  function renderFairChart(kind){
    const ctx = document.getElementById('fairChart');
    if(!ctx) return;
    if(chart){ chart.destroy(); }
    const pct = dataAreas.scores.map((v,i)=> {
      const max = dataAreas.maxs[i] || 1;
      return Math.round((v*100)/max);
    });

    const ds = {
      label: 'FAIR (%)',
      data: pct,
      borderWidth: 2,
      fill: true,
    };

    if(kind === 'bar'){
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: dataAreas.labels, datasets: [ds] },
        options: {
          responsive: true,
          scales: { y: { beginAtZero:true, max:100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });
    } else {
      chart = new Chart(ctx, {
        type: 'radar',
        data: { labels: dataAreas.labels, datasets: [ds] },
        options: {
          responsive: true,
          scales: { r: { beginAtZero:true, max:100, ticks: { stepSize: 20 } } },
          plugins: { legend: { display: false } }
        }
      });
    }
  }

  // Si tienes un <canvas id="fairChart"> en otra parte del template:
  renderFairChart('{{ chart_kind or "radar" }}');

  // Expandir / colapsar todo
  const expandBtn = document.getElementById('expand-all');
  const collapseBtn = document.getElementById('collapse-all');
  expandBtn?.addEventListener('click', ()=>{
    document.querySelectorAll('#areasAccordion .accordion-collapse').forEach(el=>{
      new bootstrap.Collapse(el, { show: true, toggle: false }).show();
    });
    document.querySelectorAll('#areasAccordion [id$="-panel"]').forEach(el=>{
      new bootstrap.Collapse(el, { show: true, toggle: false }).show();
    });
  });
  collapseBtn?.addEventListener('click', ()=>{
    document.querySelectorAll('#areasAccordion .accordion-collapse').forEach(el=>{
      new bootstrap.Collapse(el, { show: false, toggle: false }).hide();
    });
    document.querySelectorAll('#areasAccordion [id$="-panel"]').forEach(el=>{
      new bootstrap.Collapse(el, { show: false, toggle: false }).hide();
    });
  });
</script>
{% endblock %}

{% block body %}
<div class="container my-4">
  {% set groups = ['Findable','Accessible','Interoperable','Reusable'] %}

  <!-- Encabezado -->
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-3">
    <div>
      <h1 class="mb-1">{{ _('FAIR Evaluation') }}</h1>
      <div class="text-muted">
        <span class="me-3"><strong>ID:</strong> {{ resource_id }}</span>
        <span class="me-3"><strong>Plugin:</strong> {{ plugin_name }}</span>
        <span><strong>{{ _('Date') }}:</strong> {{ (now or '') }}</span>
      </div>
    </div>
    <div class="d-flex gap-2">
      {% if download_url %}
        <a class="btn btn-outline-secondary" href="{{ download_url }}" download>{{ _('Download JSON') }}</a>
      {% endif %}
      <a class="btn btn-primary" href="{{ url_for('home_' + g.language) }}">{{ _('New assessment') }}</a>
    </div>
  </div>

  <!-- Anillos concéntricos: cada anillo = un indicador -->
  <div class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3 class="h5 mb-0">{{ _('Indicators per group') }}</h3>
      <div class="ring-legend small">
        <span class="legend-item">
          <span style="display:inline-block;width:.75rem;height:.75rem;border-radius:50%;background:#2ecc71;margin-right:.35rem"></span>≥ 80%
        </span>
        <span class="legend-item">
          <span style="display:inline-block;width:.75rem;height:.75rem;border-radius:50%;background:#f1c40f;margin-right:.35rem"></span>40–79%
        </span>
        <span class="legend-item">
          <span style="display:inline-block;width:.75rem;height:.75rem;border-radius:50%;background:#e74c3c;margin-right:.35rem"></span>&lt; 40%
        </span>
      </div>
    </div>

    <div class="row g-3">
      {% for g in groups %}
        <div class="col-12 col-md-12 col-lg-3">
          <div class="card ring-card">
            <div class="card-body">
              
              <div class="position-relative" style="height:220px">
                <canvas id="ring-{{ g|lower }}" aria-label="Anillos de {{ g }}" role="img"></canvas>
              </div>
                <div class="row g-3 mt-1">
                    {% set s     = summary_by_area.get(g, {}) or {} %}
                    {% set got   = (s.get('score', 0) | float) %}
                    {% set maxv  = (s.get('max',   0) | float) %}
                    {% set denom = maxv if maxv > 0 else 1 %}
                    {% set pct   = ((100.0 * got) / denom) | round(1) %}

                    {# Color por porcentaje: verde/ámbar/rojo #}
                    {% set bar_color = '#e74c3c' %}
                    {% if pct >= 80 %}
                      {% set bar_color = '#2ecc71' %}
                    {% elif pct >= 40 %}
                      {% set bar_color = '#f1c40f' %}
                    {% endif %}

                    <div class="card area-card">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <div class="d-flex align-items-center gap-2">
                            <span class="badge" style="background: var(--color-{{ g|lower }}, #6c757d);">{{ g[0] }}</span>
                            <h6 class="mb-0">{{ g }}</h6>
                          </div>
                          <span class="score-badge">{{ got|round(2) }} / {{ maxv|round(2) }}</span>
                        </div>

                        <div class="progress mb-1"
                            role="progressbar"
                            aria-valuenow="{{ pct|int }}"
                            aria-valuemin="0"
                            aria-valuemax="100"
                            title="{{ pct }}%">
                          <div class="progress-bar"
                              style="
                                width: {{ pct }}%;
                                --bs-progress-bar-bg: {{ bar_color }};   /* BS5 */
                                background-color: {{ bar_color }};       /* fallback BS4 */
                                min-width: {{ (pct > 0) and '6px' or '0' }};
                              ">
                          </div>
                        </div>

                        <div class="text-muted small d-flex justify-content-between">
                          <span>{{ _('Progress') }}</span>
                          <span>{{ pct }}%</span>
                        </div>
                      </div>
                    </div>
                  </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Acordeones de resultados -->
  <div class="mt-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h4 class="mb-0">{{ _('Indicators details') }}</h4>
      <div class="btn-group sticky-cta">
        <button class="btn btn-sm btn-outline-primary" id="expand-all">{{ _('Expand all') }}</button>
        <button class="btn btn-sm btn-outline-secondary" id="collapse-all">{{ _('Contract all') }}</button>
      </div>
    </div>

    <div class="accordion" id="areasAccordion">
    {% for g in groups %}
      {% set area_id = 'area-' ~ g|lower %}
      {% set s     = summary_by_area.get(g, {}) or {} %}
      {% set got   = (s.get('score', 0) | float) %}
      {% set maxv  = (s.get('max',   0) | float) %}
      {% set denom = maxv if maxv > 0 else 1 %}
      {% set pct   = ((100.0 * got) / denom) | round(1) %}

      {# Color por porcentaje: verde/ámbar/rojo #}
      {% set border_color = '#e74c3c' %}
      {% if pct >= 80 %}
        {% set border_color = '#2ecc71' %}
      {% elif pct >= 40 %}
        {% set border_color = '#f1c40f' %}
      {% endif %}

      <div class="accordion-item rounded-3 mb-3 overflow-hidden" style="border: 2px solid {{ border_color }};">
        <h2 class="accordion-header" id="{{ area_id }}-hdr">
          <button
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#{{ area_id }}-body"
            aria-expanded="false"
            aria-controls="{{ area_id }}-body"
            style="
              
              /* Quitar sombras de focus de Bootstrap y alinearlas al color */
              --bs-accordion-btn-focus-border-color: {{ border_color }};
              --bs-accordion-btn-focus-box-shadow: 0 0 0 .2rem rgba(0,0,0,0);
            ">
            <div class="d-flex align-items-center gap-3 w-100">
              <span class="badge" style="background: var(--color-{{ g|lower }}, #6c757d);">{{ g[0] }}</span>
              <span class="fw-semibold">{{ g }}</span>
              <span class="ms-auto small text-muted">{{ pct }}%</span>
            </div>
          </button>
        </h2>
            <div id="{{ area_id }}-body" class="accordion-collapse collapse" data-bs-parent="#areasAccordion">
              <div class="accordion-body p-0">
                <div class="list-group list-group-flush">
                  {% for it in (indicators_by_area.get(g, []) or []) %}
                    {% set iid    = area_id ~ '-' ~ loop.index %}
                    {% set iscore = (it.score     or 0) | float %}
                    {% set imax   = (it.max_score or 0) | float %}
                    {% set denom  = imax if imax > 0 else 1 %}
                    {% set ipct   = ((100.0 * iscore) / denom) | round(1) %}

                    {# Color por porcentaje: verde/ámbar/rojo #}
                    {% set status_color = '#e74c3c' %}
                    {% if ipct >= 80 %}
                      {% set status_color = '#2ecc71' %}
                    {% elif ipct >= 40 %}
                      {% set status_color = '#f1c40f' %}
                    {% endif %}

                    <div class="list-group-item"
                        style="border-left: 6px solid {{ status_color }};">
                      <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
                        <div class="d-flex align-items-center gap-2">
                          <span class="badge bg-light text-dark">{{ _(it.id) }}</span>

                          {# Punto de estado (opcional) #}
                          <span class="d-inline-block rounded-circle"
                                title="{{ ipct }}%"
                                style="width:.6rem;height:.6rem;background: {{ status_color }};"></span>

                          {% if it.priority %}
                            <span class="badge rounded-pill
                              {% if it.priority|lower=='essential' %}bg-danger
                              {% elif it.priority|lower=='important' %}bg-warning text-dark
                              {% else %}bg-info{% endif %}">
                              {{ it.priority }}
                            </span>
                          {% endif %}
                        </div>

                        <div class="d-flex align-items-center gap-2">
                          <span class="score-badge">{{ _('Score') }}: {{ iscore|round(2) }} / {{ imax|round(2) }}</span>

                          {# Mini barra opcional  #}
                          <div class="progress" style="width:120px; height:.5rem;">
                            <div class="progress-bar"
                                style="
                                  width: {{ ipct }}%;
                                  --bs-progress-bar-bg: {{ status_color }};  /* BS5 */
                                  background-color: {{ status_color }};      /* fallback BS4 */
                                ">
                            </div>
                          </div>

                          <button class="btn btn-sm btn-outline-secondary"
                                  type="button"
                                  data-bs-toggle="collapse"
                                  data-bs-target="#{{ iid }}-panel"
                                  aria-expanded="false"
                                  aria-controls="{{ iid }}-panel">
                            Ver detalle
                          </button>
                        </div>
                      </div>

                      <div id="{{ iid }}-panel" class="collapse mt-2">
                        <div class="row g-3">
                          <div class="col-12 col-lg-7">
                            <div class="p-3 border rounded-3 h-100"
                                style="border-color: {{ status_color }};">
                              <div class="mb-2">
                                <div class="text-muted small">{{ _('Description') }}</div>
                                <div>{{ _("%s.indicator" % it.id) }}</div>
                              </div>
                              {% if it.details %}
                                <div class="mb-2">
                                  <div class="text-muted small">{{ _('Details') }}</div>
                                  <pre class="mb-0 small bg-light p-2 rounded-2">{{ _("%s.technical" % it.id) | tojson(indent=2) }}</pre>
                                </div>
                              {% endif %}
                            </div>
                          </div>

                          <div class="col-12 col-lg-5">
                            <div class="p-3 border rounded-3 h-100 d-flex flex-column gap-2"
                                style="border-color: {{ status_color }};">
                              {% if it.logs %}
                                <div>
                                  <div class="text-muted small">{{ _('Logs / Evidences') }}</div>
                                  <ul class="small mb-0">
                                    {% for msg in it.logs %}
                                      <li>{{ msg }}</li>
                                    {% endfor %}
                                  </ul>
                                </div>
                              {% endif %}
                              {% if it.recommendation %}
                                <div>
                                  <div class="text-muted small">{{ _('Tip') }}</div>
                                  <div class="small">{{ _("%s.tips" % it.id) }}</div>
                                </div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>
    </div>

    {% endfor %}
    </div>
</div>
{% endblock %}

